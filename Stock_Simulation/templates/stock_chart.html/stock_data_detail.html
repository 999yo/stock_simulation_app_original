{% extends "base.html" %}
{% block title %}{{ stock_data.company_name }}の株価詳細{% endblock %}
{% load humanize %}
{% block header %}      
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav mr-auto">
            <li class="nav-item">
              <a class="nav-link" href="{% url 'home' %}">HOME<span class="sr-only"></span></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'about' %}">ABOUT<span class="sr-only"></span></a>
              </li>
            <li class="nav-item active">
              <a class="nav-link" href="{% url 'stock_data_list' %}">シミュレーションリスト</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'user_view' %}">MY PAGE</a>
              </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'logout' %}" onclick="return confirm('本当にログアウトしますか？')">LOGOUT</a>
              </li>
          </ul>
        </div>
      </nav>
  {% endblock header %}
  
{% block content %}
<h1>{{ stock_data.company_name }}の株価詳細</h1>
<div class="table-responsive">
    <table class="table table-striped table-bordered table-hover">
    <thead>
        <tr>
            <th>企業名</th>
            <th>平均取得単価</th>
            <th>購入株数</th>
            <th>シミュレーション株価</th>
            <th>購入時時価総額</th>
            <th>シミュレーション損益</th>
            <th>5%下落したときの株価</th>
            <th>5%下落した時の評価額</th>
            <th>5%下落した時の損失益</th>
            <th>購入した日付</th>
            <th>削除</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ stock_data.company_name }}</td>
            <td>{{ stock_data.acquisition_stock_price }}</td>
            <td>{{ stock_data.number_of_shares_purchased }}</td>
            <td>{{ stock_data.simulation_stock_price }}</td>
            <td>{{ stock_data.market_capitalization_at_time_of_purchase }}</td>
            <td>{{ stock_data.simulation_stock_profit_and_loss }}</td>
            <td>{{ stock_data.stock_price_down_5per }}</td>
            <td>{{ stock_data.acquisition_stock_price_fall_5per }}</td>
            <td>{{ stock_data.acquisition_stock_price_fall_5per_profit_and_loss }}</td>
            <td>{{ stock_data.date|date:"Y/m/d" }}</td>
            <td><a class="btn btn-danger" href="{% url 'delete_saved_data' stock_data.pk %}" role="button" onclick="return confirm('本当に削除しますか？')">削除</a></td>
        </tr>
    </tbody>
</table>
    <div id="stockChart" style="width: 1800px; height: 800px;"></div>
    <script>
        // チャートデータを取得
        var timestamps = {{ timestamps|safe }};
        var prices = {{ prices|safe }};
        var purchasePrice = {{ acquisition_stock_price|default:"N/A" }};
        
        // チャートを描画
        Highcharts.stockChart('stockChart', {
           
            title: {
                text: '{{stock_data.company_name}} Chart'
            },
            yAxis: {
                title: {
                    text: '株価 (JPY)',
                    align: 'middle',
                    offset: 5

                },
                labels: {
                align: 'right', // ラベルの位置を右寄せにする
                x: -5, // ラベルを軸から5px左にずらす
                format: '{value:.1f}' // ラベルの表示フォーマットを設定（小数点2桁まで表示）
                },
                minRange: 50 // y軸の最小範囲を設定
            },
            xAxis: {
                type: 'datetime',
                title: {
                    text: '期間'
                },
                tickInterval: 24 * 3600 * 1000,
                dateTimeLabelFormats: {
                    week: '%y/%m/%d'  // 週ごとに日付を表示するフォーマットを設定
                }
            },
            tooltip: {
                formatter: function () {
                    var point = this.points[0];
                    var date = Highcharts.dateFormat('%Y-%m-%d', this.x);
                    var open = point.point.open.toFixed(1);
                    var high = point.point.high.toFixed(1);
                    var low = point.point.low.toFixed(1);
                    var close = point.point.close.toFixed(1);
    
                    // 新たに購入株価を取得し、小数点2桁まで表示
                    var purchasePrice = {{ acquisition_stock_price }};
    
                    var tooltip = '<b>' + date + '</b><br>' +
                        '始値: ' + open + '<br>' +
                        '高値: ' + high + '<br>' +
                        '安値: ' + low + '<br>' +
                        '終値: ' + close + '<br>' +
                        '購入株価: ' + purchasePrice.toFixed(1);
    
                    return tooltip;
                }
            },

            series: [
                {
                    type: 'candlestick',
                    name: 'Stock Price',
                    data: timestamps.map(function (timestamp, index) {
                        // Unixタイムスタンプをミリ秒に変換
                        var date = new Date(timestamp * 1000);
                        return [
                            date.getTime(),  // タイムスタンプ
                            prices[index][0], // 開始価格
                            prices[index][1], // 高値
                            prices[index][2], // 安値
                            prices[index][3]  // 終値
                        ];
                    })
                },
                {
                    type: 'line',
                    name: 'Purchase Price',
                    data: timestamps.map(function (timestamp) {
                        return [timestamp * 1000, purchasePrice]; // 購入株価のデータを追加
                    }),
                    color: 'pink', // ラインの色を設定
                    lineWidth: 3, // ラインの太さを設定
                    yAxis: 0, // ラインを最初のy軸に表示
                    tooltip: {
                        valueDecimals: 2 // ラインの値の小数点以下の桁数を指定
                    }
                }
            ],
            rangeSelector: {
            selected: 3, // 1は6か月を表します
            buttons: [
                {
                    type: 'week',
                    count: 1,
                    text: '1W'
                },
                {
                    type: 'month',
                    count: 1,
                    text: '1M'
                },
                {
                    type: 'month',
                    count: 3,
                    text: '3M'
                },
                {
                    type: 'month',
                    count: 6,
                    text: '6M'
                },
                
                {
                    type: 'year',
                    count: 1,
                    text: '1Y'
                },
                {
                    type: 'all',
                    text: 'All'
                }],
                inputEnabled: true
        },

            
        });
    </script>
</div>

{% endblock %}



